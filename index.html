
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>建國北路/合江街36巷口 - AI 智慧公車地圖</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Markdown Renderer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: "Noto Sans TC", sans-serif; background-color: #f3f4f6; }
        #map { height: 100%; width: 100%; z-index: 10; }
        
        /* Custom Scrollbar for the list */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        /* Marker Custom Styles */
        .home-marker {
            background-color: #ef4444;
            border: 3px solid white;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .bus-marker {
            background-color: #3b82f6;
            border: 3px solid white;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        .bus-marker:hover {
            transform: scale(1.1);
            background-color: #2563eb;
        }

        /* AI Chat Styles */
        .markdown-body p { margin-bottom: 0.5em; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.5em; }
        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #94a3b8;
            border-radius: 50%;
            animation: typing 1s infinite;
            margin: 0 2px;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Data Definitions ---
        const HOME_COORDS = [25.0558, 121.5365]; 
        const USER_ADDRESS = "建國北路二段與合江街36巷口 (大同高中對面)";

        const BUS_STOPS = [
            {
                id: 5,
                name: "長春國小 (長春路)",
                coords: [25.0545, 121.5365], 
                walkTime: "約 3 分鐘 (往南走)",
                buses: ["12", "298"],
                destinations: "往東: 民生社區、松山機場附近; 往西: 台北車站、中興醫院、三重",
                tag: "最近站點"
            },
            {
                id: 1,
                name: "南京建國路口",
                coords: [25.05185, 121.5375],
                walkTime: "約 6-8 分鐘 (往南走)",
                buses: ["307 (公車之王)", "306", "292", "266(承德幹線)", "652", "254", "282", "711", "棕9", "紅25"],
                destinations: "往西: 台北車站、西門町、板橋、三重; 往東: 小巨蛋、南京三民、南港、內湖",
                tag: "主要大站"
            },
            {
                id: 6,
                name: "台北大學 (台北校區)",
                coords: [25.0580, 121.5380], 
                walkTime: "約 5-6 分鐘 (往北走)",
                buses: ["5", "277", "505", "518(民生幹線)", "612", "638", "680"],
                destinations: "往北/東: 民生社區、內湖科技園區; 往西: 馬偕醫院、雙連",
                tag: "往北/民生東路"
            },
            {
                id: 2,
                name: "建國北路站",
                coords: [25.0540, 121.5364],
                walkTime: "約 1-2 分鐘",
                buses: ["298", "紅57"],
                destinations: "298: 行天宮、科技大樓; 紅57: 捷運科技大樓站、行天宮",
                tag: "就在門口"
            }
        ];

        // --- Gemini AI Integration ---
        const AIAssistant = ({ onClose }) => {
            const [query, setQuery] = useState("");
            const [history, setHistory] = useState([
                { role: "model", text: "您好！我是您的私人交通助理。想去哪裡？或是想知道附近有什麼好吃的？請告訴我！" }
            ]);
            const [isLoading, setIsLoading] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => {
                if (scrollRef.current) {
                    scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
                }
            }, [history]);

            const handleSend = async () => {
                if (!query.trim()) return;
                
                const userMsg = query;
                setQuery("");
                setHistory(prev => [...prev, { role: "user", text: userMsg }]);
                setIsLoading(true);

                try {
                    const apiKey = ""; // Runtime provided key
                    const promptContext = `
                        角色設定：你是一位住在台北市中山區「${USER_ADDRESS}」的在地交通專家。
                        你的任務：根據以下「使用者家附近的公車站牌資料」，回答使用者的交通或周邊生活問題。
                        
                        可用站牌資料：
                        ${JSON.stringify(BUS_STOPS, null, 2)}
                        
                        回答原則：
                        1. 優先推薦使用者走路能到的上述站牌來搭公車。
                        2. 清楚說明：先走到哪個站（需時幾分）、搭幾號公車、方向為何。
                        3. 如果附近公車無法直達，可建議轉乘捷運（最近的是松江南京站，走路約 10 分鐘）。
                        4. 語氣親切、在地化，使用繁體中文。
                        5. 可以回答關於這些路線經過的景點或美食推薦。
                    `;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: promptContext + "\n\n使用者問題: " + userMsg }]
                            }]
                        })
                    });

                    const data = await response.json();
                    
                    if (data.error) {
                         throw new Error(data.error.message);
                    }

                    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "抱歉，我現在無法查詢交通資訊，請稍後再試。";
                    
                    setHistory(prev => [...prev, { role: "model", text: aiText }]);
                } catch (error) {
                    setHistory(prev => [...prev, { role: "model", text: "發生錯誤，請檢查網路連線或稍後再試。" }]);
                    console.error("Gemini API Error:", error);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="flex flex-col h-full bg-slate-50">
                    <div className="p-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white shrink-0 shadow-md">
                        <div className="flex justify-between items-center">
                            <h2 className="font-bold text-lg flex items-center gap-2">
                                <i className="fas fa-robot"></i> AI 交通助理
                            </h2>
                            <button onClick={onClose} className="text-white/80 hover:text-white">
                                <i className="fas fa-times"></i>
                            </button>
                        </div>
                        <p className="text-xs text-indigo-100 mt-1">由 Gemini 提供即時建議</p>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 space-y-4" ref={scrollRef}>
                        {history.map((msg, idx) => (
                            <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] rounded-2xl px-4 py-3 shadow-sm text-sm leading-relaxed ${
                                    msg.role === 'user' 
                                    ? 'bg-indigo-600 text-white rounded-br-none' 
                                    : 'bg-white text-slate-800 border border-slate-200 rounded-bl-none'
                                }`}>
                                    {msg.role === 'model' ? (
                                        <div className="markdown-body" dangerouslySetInnerHTML={{ __html: marked.parse(msg.text) }} />
                                    ) : (
                                        msg.text
                                    )}
                                </div>
                            </div>
                        ))}
                        {isLoading && (
                            <div className="flex justify-start">
                                <div className="bg-white border border-slate-200 rounded-2xl rounded-bl-none px-4 py-3 shadow-sm">
                                    <div className="typing-indicator">
                                        <span></span><span></span><span></span>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="p-3 bg-white border-t border-slate-200 shrink-0">
                        <div className="flex gap-2">
                            <input
                                type="text"
                                value={query}
                                onChange={(e) => setQuery(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                                placeholder="輸入目的地 (例: 去士林夜市、附近美食)"
                                className="flex-1 border border-slate-300 rounded-full px-4 py-2 focus:outline-none focus:border-indigo-500 text-sm"
                                disabled={isLoading}
                            />
                            <button 
                                onClick={handleSend}
                                disabled={isLoading || !query.trim()}
                                className={`w-10 h-10 rounded-full flex items-center justify-center text-white transition-colors ${
                                    isLoading || !query.trim() ? 'bg-slate-300' : 'bg-indigo-600 hover:bg-indigo-700'
                                }`}
                            >
                                <i className="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        function App() {
            const [selectedStop, setSelectedStop] = useState(BUS_STOPS[0]); 
            const [viewMode, setViewMode] = useState('list'); // 'list' or 'ai'
            const mapRef = useRef(null);
            const markersRef = useRef({});

            useEffect(() => {
                if (!mapRef.current) {
                    // Initialize Map
                    const map = L.map('map').setView(HOME_COORDS, 16);
                    mapRef.current = map;

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);

                    // Add Home Marker
                    const homeIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div class="home-marker" style="width: 36px; height: 36px;"><i class="fas fa-home"></i></div>`,
                        iconSize: [36, 36],
                        iconAnchor: [18, 18]
                    });
                    
                    L.marker(HOME_COORDS, { icon: homeIcon })
                     .addTo(map)
                     .bindPopup("<b>您的位置</b><br>建國北路二段 / 合江街36巷<br>(大同高中對面)")
                     .openPopup();

                    // Add Bus Stop Markers
                    BUS_STOPS.forEach(stop => {
                        const busIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div class="bus-marker" style="width: 32px; height: 32px;"><i class="fas fa-bus"></i></div>`,
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        });

                        const marker = L.marker(stop.coords, { icon: busIcon }).addTo(map);
                        
                        marker.on('click', () => {
                            setSelectedStop(stop);
                            setViewMode('list'); // Switch back to list view on marker click
                            map.setView(stop.coords, 17, { animate: true });
                        });

                        markersRef.current[stop.id] = marker;
                    });
                    
                    // --- FIX: 解決地圖只顯示一部分的問題 ---
                    // 當地圖初始化完成後，強制重新計算一次大小
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 500);
                }

                // 額外保險：監聽視窗大小改變，隨時校正地圖
                const handleResize = () => {
                    if (mapRef.current) {
                        mapRef.current.invalidateSize();
                    }
                }
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);

            }, []);

            const handleSelectStop = (stop) => {
                setSelectedStop(stop);
                setViewMode('list');
                if (mapRef.current) {
                    // 點擊站牌時，也順便校正一次，確保萬無一失
                    mapRef.current.invalidateSize(); 
                    mapRef.current.setView(stop.coords, 17, { animate: true });
                    if(markersRef.current[stop.id]) {
                        markersRef.current[stop.id].openPopup();
                    }
                }
            };

            return (
                <div className="flex flex-col h-screen md:flex-row">
                    
                    {/* Map Container */}
                    <div className="w-full h-[40vh] md:h-full md:w-2/3 relative order-1 md:order-2">
                        <div id="map"></div>
                        
                        <div className="absolute top-4 right-4 bg-white p-3 rounded-lg shadow-lg z-[1000] text-sm opacity-90 hidden sm:block">
                            <div className="flex items-center mb-2">
                                <div className="w-4 h-4 rounded-full bg-red-500 border-2 border-white mr-2 shadow"></div>
                                <span>您的位置</span>
                            </div>
                            <div className="flex items-center">
                                <div className="w-4 h-4 rounded-full bg-blue-500 border-2 border-white mr-2 shadow"></div>
                                <span>公車站牌</span>
                            </div>
                        </div>
                    </div>

                    {/* Sidebar Container */}
                    <div className="w-full h-[60vh] md:h-full md:w-1/3 bg-white flex flex-col shadow-xl order-2 md:order-1 z-20 relative">
                        
                        {/* Global Sidebar Header */}
                        <div className="bg-slate-800 text-white p-4 shrink-0 flex justify-between items-center">
                            <div>
                                <h1 className="text-lg font-bold flex items-center gap-2">
                                    <i className="fas fa-map-marked-alt"></i> 公車轉乘資訊
                                </h1>
                                <p className="text-slate-400 text-xs mt-0.5">建國北路二段 / 合江街36巷</p>
                            </div>
                            
                            {/* Toggle Button */}
                            <div className="flex bg-slate-700 rounded-lg p-1">
                                <button 
                                    onClick={() => setViewMode('list')}
                                    className={`px-3 py-1.5 rounded-md text-sm transition-all ${viewMode === 'list' ? 'bg-slate-500 text-white shadow' : 'text-slate-400 hover:text-white'}`}
                                >
                                    <i className="fas fa-list-ul"></i>
                                </button>
                                <button 
                                    onClick={() => setViewMode('ai')}
                                    className={`px-3 py-1.5 rounded-md text-sm transition-all flex items-center gap-1 ${viewMode === 'ai' ? 'bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow' : 'text-slate-400 hover:text-white'}`}
                                >
                                    <i className="fas fa-sparkles"></i> AI
                                </button>
                            </div>
                        </div>

                        {/* Content Area - Switch between List and AI */}
                        <div className="flex-1 overflow-hidden relative">
                            {viewMode === 'ai' ? (
                                <AIAssistant onClose={() => setViewMode('list')} />
                            ) : (
                                <div className="flex flex-col h-full">
                                    {/* Stops Tabs */}
                                    <div className="flex overflow-x-auto bg-slate-100 p-2 shrink-0 border-b custom-scroll">
                                        {BUS_STOPS.map(stop => (
                                            <button
                                                key={stop.id}
                                                onClick={() => handleSelectStop(stop)}
                                                className={`flex-shrink-0 px-4 py-2 mr-2 rounded-full text-sm font-medium transition-colors ${
                                                    selectedStop.id === stop.id 
                                                    ? 'bg-blue-600 text-white shadow' 
                                                    : 'bg-white text-slate-600 hover:bg-slate-200'
                                                }`}
                                            >
                                                {stop.name}
                                            </button>
                                        ))}
                                    </div>

                                    {/* Stop Details */}
                                    <div className="flex-1 overflow-y-auto p-5 custom-scroll bg-white">
                                        {selectedStop ? (
                                            <div className="animate-fade-in">
                                                <div className="flex justify-between items-start mb-4 border-b pb-4">
                                                    <div>
                                                        <h2 className="text-xl font-bold text-slate-800">{selectedStop.name}</h2>
                                                        <span className="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mt-2">
                                                            {selectedStop.tag}
                                                        </span>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="text-xs text-slate-500">步行時間</div>
                                                        <div className="text-base font-bold text-green-600 flex items-center justify-end gap-1">
                                                            <i className="fas fa-walking"></i> {selectedStop.walkTime}
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="mb-6">
                                                    <h3 className="text-xs font-bold text-slate-400 uppercase mb-2 tracking-wide">主要目的地</h3>
                                                    <div className="bg-slate-50 p-3 rounded-lg border-l-4 border-blue-400 text-sm text-slate-700 leading-relaxed">
                                                        {selectedStop.destinations}
                                                    </div>
                                                </div>

                                                <div>
                                                    <h3 className="text-xs font-bold text-slate-400 uppercase mb-2 tracking-wide">停靠公車路線</h3>
                                                    <div className="flex flex-wrap gap-2">
                                                        {selectedStop.buses.map((bus, idx) => (
                                                            <span key={idx} className="px-3 py-1 bg-white border border-slate-200 rounded-md text-slate-700 text-sm font-mono shadow-sm hover:border-blue-300 hover:text-blue-600 transition-colors cursor-default">
                                                                {bus}
                                                            </span>
                                                        ))}
                                                    </div>
                                                </div>
                                                
                                                <div className="mt-6 pt-4 border-t border-slate-100">
                                                    <a 
                                                        href={`https://www.google.com/maps/dir/?api=1&destination=${selectedStop.coords[0]},${selectedStop.coords[1]}&travelmode=walking`} 
                                                        target="_blank"
                                                        className="block w-full text-center bg-slate-800 hover:bg-slate-700 text-white font-medium py-3 rounded-lg transition-colors text-sm"
                                                    >
                                                        <i className="fas fa-directions mr-2"></i> 開啟 Google Maps 步行導航
                                                    </a>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="h-full flex items-center justify-center text-slate-400 text-sm">
                                                請點擊地圖上的站牌查看詳情
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>